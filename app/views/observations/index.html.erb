<% provide(:title, "Map") %>

<% content_for :maps do %>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<% end %>

<div id="map"></div>

<%= render "app_intro" unless current_user %>

<script>
  // Set up some default options
  var options = {
    zoom: 13
  }
  // Set the map
  var map = L.map('map', {
    options
  });
  // Add the tile layers
  L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);
  map.spin(true,{
    lines: 9, 
    length: 20,
    color: '#0f2a47',
    zIndex: 1000
  });
  // Use locate to add the users current position
  map.locate({setView: true, maxZoom: 16});
  // Once the location is found add a marker and hide the pre-loader
  map.on('locationfound', onLocationFound);
  function onLocationFound(e) {
    L.marker(e.latlng).bindPopup("This is me!").addTo(map);
    map.spin(false);
  }
  // Load some dummy data for multiple markers
  var places = [
    <% @observations.each do |observation| %>
      [ 
        <%= observation.coordinates.join(", ") %>,
        '<%= observation.description %>',
        '<%= link_to "View observation", observation %>'
      ],
    <% end %>
  ];
  // Set our multiple markers
  for (var i = 0; i < places.length; i++) {
    marker = new L.marker([places[i][0],places[i][1]])
      .bindPopup(
        '<div class="map_popup">' + places[i][2] + '<p>' + places[i][3] + '</p></div>'
      ).addTo(map);
  }
</script>